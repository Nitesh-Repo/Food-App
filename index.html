<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlavorCrate - Order Food</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="icon" href="logo.png" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: 'hsl(25, 95%, 53%)',
                        'primary-foreground': 'hsl(0, 0%, 98%)',
                        secondary: 'hsl(35, 100%, 95%)',
                        'secondary-foreground': 'hsl(25, 30%, 25%)',
                        background: 'hsl(0, 0%, 100%)',
                        foreground: 'hsl(0, 0%, 3.9%)',
                        card: 'hsl(0, 0%, 100%)',
                        'card-foreground': 'hsl(0, 0%, 3.9%)',
                        popover: 'hsl(0, 0%, 100%)',
                        'popover-foreground': 'hsl(0, 0%, 3.9%)',
                        muted: 'hsl(0, 0%, 96.1%)',
                        'muted-foreground': 'hsl(0, 0%, 45.1%)',
                        accent: 'hsl(0, 0%, 96.1%)',
                        'accent-foreground': 'hsl(0, 0%, 9%)',
                        destructive: 'hsl(0, 84.2%, 60.2%)',
                        'destructive-foreground': 'hsl(0, 0%, 98%)',
                        border: 'hsl(0, 0%, 89.8%)',
                        input: 'hsl(0, 0%, 89.8%)',
                        ring: 'hsl(25, 95%, 53%)',
                    }
                }
            }
        }
    </script>
    <style>
        .delivery-vehicle {
            transition: all 2s ease-in-out;
        }

        #map {
            z-index: 0 !important;
        }

        .route-line {
            stroke-dasharray: 10, 5;
            animation: dash 1s linear infinite;
        }

        @keyframes dash {
            to {
                stroke-dashoffset: -15;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-orange-50 to-yellow-50">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b border-orange-100 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <!-- <span class="text-2xl">üçΩÔ∏è</span> -->
                <img src="logo.png" alt="FlavorCrate Logo" class="w-12 h-12 object-contain" />
                <h1 class="text-2xl font-bold text-orange-600">FlavorCrate</h1>
            </div>

            <!-- Profile Dropdown -->
            <div class="relative">
                <button id="profileBtn"
                    class="flex items-center space-x-2 bg-orange-100 text-orange-700 px-4 py-2 rounded-full hover:bg-orange-200 transition">
                    <span class="text-lg">üë§</span>
                    <span id="userName" class="font-medium">User</span>
                    <span class="text-sm">‚ñº</span>
                </button>

                <div id="profileDropdown"
                    class="hidden absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-50">
                    <div class="p-4 border-b border-gray-100">
                        <div class="space-y-2 text-sm">
                            <div><strong>Username:</strong> <span id="profileUsername"></span></div>
                            <div><strong>Email:</strong> <span id="profileEmail"></span></div>
                            <div><strong>Phone:</strong> <span id="profilePhone"></span></div>
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <strong>Address:</strong>
                                    <div id="profileAddress" class="mt-1"></div>
                                </div>
                                <button id="editAddressBtn"
                                    class="ml-2 text-orange-600 hover:text-orange-800 text-lg">‚úèÔ∏è</button>
                            </div>
                            <a href="order-history.html"
                                class="block px-4 py-2 text-sm text-orange-700 hover:bg-orange-100 border-t border-gray-200">
                                üßæ View Order History
                            </a>
                        </div>
                    </div>
                    <div class="p-4">
                        <button id="logoutBtn"
                            class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Address Edit Modal -->
    <div id="addressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-semibold mb-4">Edit Address</h3>
            <textarea id="newAddress"
                class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500"
                rows="4"></textarea>
            <div class="flex gap-3 mt-4">
                <button id="saveAddressBtn"
                    class="flex-1 bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600 transition">
                    Save
                </button>
                <button id="cancelAddressBtn"
                    class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <main class="container mx-auto px-4 py-8">
        <!-- Welcome Section -->
        <div class="text-center mb-8">
            <h2 id="welcomeMessage" class="text-3xl font-bold text-gray-800 mb-2">Welcome to FlavorCrate!</h2>
            <p class="text-gray-600">Delicious food delivered fresh to your doorstep</p>
        </div>

        <!-- Food Menu Filters -->
        <div class="mb-6">
            <div class="flex justify-center space-x-4">
                <button id="filterAll"
                    class="px-6 py-2 rounded-full bg-orange-500 text-white font-medium transition hover:bg-orange-600">
                    All
                </button>
                <button id="filterVeg"
                    class="px-6 py-2 rounded-full bg-gray-200 text-gray-700 font-medium transition hover:bg-gray-300">
                    üå± Vegetarian
                </button>
                <button id="filterNonVeg"
                    class="px-6 py-2 rounded-full bg-gray-200 text-gray-700 font-medium transition hover:bg-gray-300">
                    üçñ Non-Vegetarian
                </button>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Food Menu -->
            <div class="lg:col-span-2">
                <h3 class="text-2xl font-bold mb-6 text-gray-800">Our Menu</h3>
                <div id="foodMenu" class="grid md:grid-cols-2 gap-6">
                    <!-- Menu items will be populated here -->
                </div>
            </div>

            <!-- Cart Sidebar -->
            <div class="space-y-6">
                <!-- Cart -->
                <div class="bg-white rounded-lg shadow-lg p-6 border border-orange-100">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 flex items-center">
                        üõí Cart
                        <span id="cartCount"
                            class="ml-2 bg-orange-500 text-white text-sm px-2 py-1 rounded-full">0</span>
                    </h3>
                    <div id="cartItems" class="space-y-3 mb-4">
                        <p class="text-gray-500 text-center py-4">Your cart is empty</p>
                    </div>
                    <div id="cartTotal" class="border-t pt-4 hidden">
                        <div class="mb-4">
                            <label for="promoCode" class="block text-sm font-medium text-gray-700 mb-1">Promo
                                Code</label>
                            <div class="flex">
                                <input id="promoCode" type="text" placeholder="Enter code"
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-l-md focus:ring-orange-500 focus:outline-none">
                                <button id="applyPromoBtn"
                                    class="bg-orange-500 text-white px-4 rounded-r-md hover:bg-orange-600 transition">Apply</button>
                            </div>
                            <p id="promoStatus" class="text-sm mt-1 text-green-600 hidden">Promo applied!</p>
                        </div>

                        <div class="flex justify-between items-center text-lg font-bold">
                            <!-- <span>Total: </span> -->
                            <span id="totalAmount" class="text-right px-2">‚Çπ0</span>
                        </div>
                        <div class="flex gap-3 mt-4">
                            <button id="checkoutBtn"
                                class="flex-1 bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition">
                                Checkout
                            </button>
                            <button id="emptyCartBtn"
                                class="flex-1 bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition">
                                Empty Cart
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Map Section -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6 border border-orange-100">
            <h3 class="text-2xl font-bold mb-6 text-gray-800">üó∫Ô∏è Delivery Map</h3>
            <div id="orderTracking" class="hidden mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h4 class="font-semibold text-blue-800">Order Status</h4>
                        <p id="trackingStatus" class="text-blue-600">Preparing your order...</p>
                    </div>
                    <div id="estimatedTime" class="text-right">
                        <div class="text-sm text-gray-600">Estimated Time</div>
                        <div class="text-lg font-bold text-blue-800">25-30 min</div>
                    </div>
                </div>
            </div>
            <div id="map" class="h-96 rounded-lg border border-gray-300"></div>
        </div>
        <!-- Contact Section -->
        <section id="contact" class="mt-8 bg-white rounded-lg shadow-lg p-6 border border-orange-100">
            <h2 class="text-2xl font-bold text-orange-600 mb-4">üìû Contact Us</h2>
            <p class="text-gray-700 mb-4">For Support or Inquiries, reach out to us:</p>
            <div class="contact-info space-y-2 text-sm text-gray-800">
                <p>üì± <a href="https://wa.me/+918299745297" target="_blank" class="text-blue-600 hover:underline">+91
                        8299745297</a></p>
                <p>üìß <a href="mailto:support@flavorcrate.com"
                        class="text-blue-600 hover:underline">support@flavorcrate.com</a></p>
                <p>üìç <a href="https://www.google.com/maps/search/pooja+hotel+Numaish+chauraha,+Hardoi,+Uttar+Pradesh,+India"
                        target="_blank" class="text-blue-600 hover:underline">Hardoi, Uttar Pradesh, India</a></p>
            </div>
            <p class="mt-4 text-gray-600 text-sm">We are here to help you with any questions or concerns!</p>
        </section>

    </main>

    <script>
        // Global variables
        let currentFilter = 'all';
        let currentUser = null;
        let cart = [];
        let promoApplied = false;
        let promoDiscount = 0;
        let map = null;
        let kitchenMarker = null;
        let userMarker = null;
        let deliveryVehicle = null;
        let routeLine = null;
        let currentOrder = null;

        // Kitchen location (fixed)
        const kitchenLocation = [27.406961, 80.126763]; // Sample coordinates

        // Food menu data
        const menuItems = [
            { id: 1, name: "Veg Thali", price: 120, category: "veg", rating: 4.5, image: "images/VT.jfif", description: "3 sabzis, dal, rice, roti, salad, pickle,curd" },
            { id: 2, name: "Chicken Biryani", price: 349, category: "non-veg", rating: 4.8, image: "images/cb.jfif", description: "Aromatic basmati rice with tender chicken" },
            { id: 3, name: "Protein Bowl", price: 149, category: "non-veg", rating: 4.2, image: "images/PB.jfif", description: "Grilled paneer/chicken, quinoa, veggies, and hummus" },
            { id: 4, name: "Dal Tadka", price: 100, category: "veg", rating: 4.7, image: "images/DT.jfif", description: "Yellow dal cooked with Indian spices" },
            { id: 5, name: "Veg Sandwich", price: 79, category: "veg", rating: 4.6, image: "images/VS.jfif", description: "Low fat sandwich filled with veggies and cheese" },
            { id: 6, name: "Mutton Curry", price: 429, category: "non-veg", rating: 4.4, image: "images/MC.jfif", description: "Delicious mutton curry made with Indian spices" },
            { id: 7, name: "Sprouts Bowl", price: 150, category: "veg", rating: 4.3, image: "images/sb.jfif", description: "A base of sprouted beans, like mung beans, along with fresh vegetables, herbs, and spices" },
            { id: 8, name: "Chole Bhature", price: 99, category: "veg", rating: 4.6, image: "images/CBh.jfif", description: "Spicy chickpea curry (chole) paired with deep-fried bread (bhature)" }
        ];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            // Check if user is logged in
            const userData = localStorage.getItem('flavorcrateUser');
            if (!userData) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(userData);
            initializeApp();
        });

        function initializeApp() {
            updateUI();
            renderMenu();
            initializeMap();
            // loadOrderHistory();
            setupEventListeners();
        }

        function updateUI() {
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('welcomeMessage').textContent = `Welcome back, ${currentUser.username}!`;

            // Update profile dropdown
            document.getElementById('profileUsername').textContent = currentUser.username;
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profilePhone').textContent = currentUser.phone;
            document.getElementById('profileAddress').textContent = currentUser.address;
        }

        function applyPromoCode() {
            const code = document.getElementById('promoCode').value.trim().toUpperCase();
            const status = document.getElementById('promoStatus');

            // Example promo logic
            if (code.toUpperCase() === "FLAVOR50" && !promoApplied) {
                promoDiscount = 50;
                promoApplied = true;
                status.textContent = "‚Çπ50 off applied!";
                status.classList.remove("hidden");
                updateCartUI();
            } else if (promoApplied) {
                status.textContent = "Promo already applied.";
                status.classList.remove("hidden");
            } else {
                status.textContent = "Invalid promo code.";
                status.classList.remove("hidden");
                status.classList.remove("text-green-600");
                status.classList.add("text-red-600");
            }
        }
        document.getElementById('applyPromoBtn').addEventListener('click', applyPromoCode);

        function renderMenu(filter = 'all') {
            const menuContainer = document.getElementById('foodMenu');
            const filteredItems = filter === 'all' ? menuItems : menuItems.filter(item => item.category === filter);

            menuContainer.innerHTML = filteredItems.map(item => {
                const cartItem = cart.find(ci => ci.id === item.id);
                const quantityControl = cartItem ? `
            <div class="flex items-center space-x-2">
                <button onclick="updateQuantity(${item.id}, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600">-</button>
                <span class="text-sm font-medium w-6 text-center">${cartItem.quantity}</span>
                <button onclick="updateQuantity(${item.id}, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600">+</button>
            </div>
        ` : `
            <button onclick="addToCart(${item.id})" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition text-sm font-medium">
                Add to Cart
            </button>
        `;

                return `
            <div class="bg-white rounded-lg shadow-md border border-gray-200 hover:shadow-lg transition-shadow">
                <div class="p-6">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-3">
                            <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md" />
                            <div>
                                <h4 class="font-semibold text-lg">${item.name}</h4>
                                <div class="flex items-center space-x-1 text-sm text-gray-600">
                                    <span>‚≠ê</span>
                                    <span>${item.rating}</span>
                                </div>
                            </div>
                        </div>
                        <span class="text-lg font-bold text-orange-600">‚Çπ${item.price}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">${item.description}</p>
                    <div class="flex items-center justify-between">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${item.category === 'veg' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            ${item.category === 'veg' ? 'üå± Veg' : 'üçñ Non-Veg'}
                        </span>
                        ${quantityControl}
                    </div>
                </div>
            </div>
        `;
            }).join('');
        }



        function addToCart(itemId) {
            const item = menuItems.find(i => i.id === itemId);
            const existingItem = cart.find(i => i.id === itemId);

            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...item, quantity: 1 });
            }

            updateCartUI();
            renderMenu(currentFilter);
        }

        function updateCartUI() {
            const cartContainer = document.getElementById('cartItems');
            const cartCount = document.getElementById('cartCount');
            const cartTotal = document.getElementById('cartTotal');
            const totalAmount = document.getElementById('totalAmount');

            if (cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-gray-500 text-center py-4">Your cart is empty</p>';
                cartTotal.classList.add('hidden');
                cartCount.textContent = '0';
                return;
            }

            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discount = promoApplied ? promoDiscount : 0;
            let discountedTotal = Math.max(subtotal - discount, 0);
            let deliveryCharge = discountedTotal < 199 ? 20 : 0;
            let finalTotal = discountedTotal + deliveryCharge;

            cartCount.textContent = totalItems;

            // Update DOM
            totalAmount.innerHTML = `
    <div class="mt- border-t pt-4 text-sm text-gray-700 space-y-2">
        <div class="flex justify-between">
            <span>Subtotal:</span>
            <span>‚Çπ${subtotal}</span>
        </div>
        ${discount > 0 ? `
        <div class="flex justify-between text-green-600">
            <span>Discount:</span>
            <span>-‚Çπ${discount}</span>
        </div>` : ""}
        
        <div class="flex justify-between">
            <span>Delivery:</span>
            <span>‚Çπ${deliveryCharge}</span>
        </div>
        <div class="flex justify-between font-bold text-base text-gray-900 border-t pt-3">
            <span>Total:</span>
            <span>‚Çπ${finalTotal.toFixed(2)}</span>
        </div>
    </div>
`;



            cartTotal.classList.remove('hidden');

            cartContainer.innerHTML = cart.map(item => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-md">
            <div class="flex-1">
                <div class="font-medium text-sm">${item.name}</div>
                <div class="text-xs text-gray-600">‚Çπ${item.price} each</div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="updateQuantity(${item.id}, -1)" class="w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600 transition">-</button>
                <span class="text-sm font-medium w-8 text-center">${item.quantity}</span>
                <button onclick="updateQuantity(${item.id}, 1)" class="w-6 h-6 bg-green-500 text-white rounded-full text-xs hover:bg-green-600 transition">+</button>
            </div>
        </div>
    `).join('');
        }


        function updateQuantity(itemId, change) {
            const item = cart.find(i => i.id === itemId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    cart = cart.filter(i => i.id !== itemId);
                }
                updateCartUI();
                renderMenu(currentFilter);
            }
        }

        function emptyCart() {
            cart = [];
            promoApplied = false; // <-- reset promo state
            promoDiscount = 0;
            document.getElementById('promoCode').value = ''; // optional: clear input field
            document.getElementById('promoStatus').classList.add('hidden'); // hide promo message
            updateCartUI();
            renderMenu(currentFilter);
        }


        async function checkout() {
            if (cart.length === 0) return;

            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let discount = promoApplied ? promoDiscount : 0;
            let discountedTotal = Math.max(subtotal - discount, 0);
            let deliveryCharge = discountedTotal < 199 ? 20 : 0;
            let finalTotal = discountedTotal + deliveryCharge;

            // Simulate payment
            alert(`Payment successful!\nTotal Payable: ‚Çπ${finalTotal.toFixed(2)}\n\nYour order is being prepared.`);

            // Save order
            const order = {
                id: Date.now(),
                items: [...cart],
                total: finalTotal.toFixed(2),
                timestamp: new Date().toISOString(),
                status: 'preparing'
            };

            async function generateBillPDF(order) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const margin = 20;
                let y = margin;

                doc.setFontSize(18);
                doc.text("FlavorCrate - Order Receipt", margin, y);
                y += 10;

                doc.setFontSize(12);
                doc.text(`Order ID: ${order.id}`, margin, y);
                doc.text(`Date: ${new Date(order.timestamp).toLocaleString()}`, margin, y + 7);
                y += 18;

                // Table Header
                doc.setFontSize(13);
                doc.setFont(undefined, 'bold');
                doc.text("Item", margin, y);
                doc.text("Qty", margin + 100, y);
                doc.text("Price", margin + 130, y);
                doc.setFont(undefined, 'normal');
                y += 8;

                // Divider
                doc.line(margin, y, 190 - margin, y);
                y += 5;

                order.items.forEach(item => {
                    doc.text(item.name, margin, y);
                    doc.text("" + (item.quantity), margin + 100, y);
                    doc.text("INR " + (item.price * item.quantity).toFixed(2), margin + 130, y);
                    y += 8;
                });

                y += 5;
                doc.line(margin, y, 190 - margin, y);
                y += 10;

                // Summary Section
                const summary = [
                    ["Subtotal", "INR " + (order.subtotal).toFixed(2)],
                    ...(order.discount > 0 ? [["Discount", "INR -" + (order.discount).toFixed(2)]] : []),
                    ["Delivery", "INR " + (order.deliveryCharge).toFixed(2)],
                    ["Total", "INR " + (order.total)]
                ];

                summary.forEach(([label, value], i) => {
                    const isTotal = label === "Total";
                    if (isTotal) {
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(14);
                    } else {
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(12);
                    }

                    doc.text(label, margin, y);
                    doc.text(value, margin + 130, y);
                    y += isTotal ? 10 : 8;
                });

                y += 10;
                doc.setFontSize(10);
                doc.text("Thank you for ordering with FlavorCrate!", margin, y);

                doc.save(`FlavorCrate_Bill_${order.id}.pdf`);
            }

            await generateBillPDF({
                id: order.id,
                timestamp: order.timestamp,
                items: order.items,
                subtotal: subtotal,
                discount: discount,
                deliveryCharge: deliveryCharge,
                total: finalTotal.toFixed(2)
            });


            const orderHistory = JSON.parse(localStorage.getItem(`orderHistory_${currentUser.email}`) || '[]');
            orderHistory.unshift(order);
            localStorage.setItem(`orderHistory_${currentUser.email}`, JSON.stringify(orderHistory));

            // Start tracking
            currentOrder = order;
            startOrderTracking();

            // Clear cart
            emptyCart();
            // loadOrderHistory();
        }


        function loadOrderHistory() {
            const orderHistory = JSON.parse(localStorage.getItem(`orderHistory_${currentUser.email}`) || '[]');
            const container = document.getElementById('orderHistory');

            if (orderHistory.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No orders yet</p>';
                return;
            }

            container.innerHTML = orderHistory.map(order => `
                <div class="border border-gray-200 rounded-lg p-4 mb-4">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <div class="font-semibold">Order #${order.id}</div>
                            <div class="text-sm text-gray-600">${new Date(order.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-green-600">‚Çπ${order.total}</div>
                            <div class="text-sm px-2 py-1 rounded-full ${getStatusClass(order.status)}">
                                ${getStatusText(order.status)}
                            </div>
                        </div>
                    </div>
                    <div class="space-y-1">
                        ${order.items.map(item => `
                            <div class="flex justify-between text-sm">
                                <span>${item.name} x${item.quantity}</span>
                                <span>‚Çπ${item.price * item.quantity}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(status) {
            const classes = {
                'preparing': 'bg-yellow-100 text-yellow-800',
                'on-route': 'bg-blue-100 text-blue-800',
                'delivered': 'bg-green-100 text-green-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getStatusText(status) {
            const texts = {
                'preparing': 'Preparing',
                'on-route': 'On Route',
                'delivered': 'Delivered'
            };
            return texts[status] || 'Unknown';
        }

        function startOrderTracking() {
            const trackingDiv = document.getElementById('orderTracking');
            const statusSpan = document.getElementById('trackingStatus');

            trackingDiv.classList.remove('hidden');

            // Simulate order progression
            setTimeout(() => {
                statusSpan.textContent = 'Order confirmed! Preparing your food...';
                currentOrder.status = 'preparing';
                updateOrderInHistory();
            }, 1000);

            setTimeout(() => {
                statusSpan.textContent = 'Food ready! Driver on the way...';
                currentOrder.status = 'on-route';
                updateOrderInHistory();
                startDeliveryAnimation();
            }, 5000);

            setTimeout(() => {
                statusSpan.textContent = 'Order delivered! Enjoy your meal!';
                currentOrder.status = 'delivered';
                updateOrderInHistory();
                trackingDiv.classList.add('hidden');
            }, 15000);
        }

        function updateOrderInHistory() {
            const orderHistory = JSON.parse(localStorage.getItem(`orderHistory_${currentUser.email}`) || '[]');
            const orderIndex = orderHistory.findIndex(o => o.id === currentOrder.id);
            if (orderIndex !== -1) {
                orderHistory[orderIndex] = currentOrder;
                localStorage.setItem(`orderHistory_${currentUser.email}`, JSON.stringify(orderHistory));
                loadOrderHistory();
            }
        }

        function startDeliveryAnimation() {
            if (!userMarker || !deliveryVehicle) return;

            const kitchenPos = kitchenMarker.getLatLng();
            const userPos = userMarker.getLatLng();

            // Animate delivery vehicle from kitchen to user
            let progress = 0;
            const animation = setInterval(() => {
                progress += 0.02;

                const lat = kitchenPos.lat + (userPos.lat - kitchenPos.lat) * progress;
                const lng = kitchenPos.lng + (userPos.lng - kitchenPos.lng) * progress;

                deliveryVehicle.setLatLng([lat, lng]);

                if (progress >= 1) {
                    clearInterval(animation);
                }
            }, 100);
        }

        async function initializeMap() {
            map = L.map('map').setView(kitchenLocation, 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add kitchen marker
            kitchenMarker = L.marker(kitchenLocation)
                .addTo(map)
                .bindPopup('üè™ FlavorCrate Kitchen')
                .openPopup();

            // Add delivery vehicle marker (initially at kitchen)
            deliveryVehicle = L.marker(kitchenLocation, {
                icon: L.divIcon({
                    html: 'üöó',
                    iconSize: [30, 30],
                    className: 'delivery-vehicle'
                })
            }).addTo(map);

            // Geocode user address and add marker
            await geocodeAndAddUserMarker();
        }

        
        function calculateDistance(lat1, lon1, lat2, lon2) {
  const toRad = deg => deg * Math.PI / 180;
  const R = 6371; // Earth radius in km
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
            Math.sin(dLon / 2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c; // Distance in km
}
function estimateDeliveryTime(distanceKm, speedKmph = 30) {
  const timeHours = distanceKm / speedKmph;
  const timeMinutes = Math.round(timeHours * 60);
  return timeMinutes;
}

        
        
        async function geocodeAndAddUserMarker() {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(currentUser.address)}&limit=1`);
                const data = await response.json();

                if (data.length > 0) {
                    const userLocation = [parseFloat(data[0].lat), parseFloat(data[0].lon)];

                    // Remove existing user marker if any
                    if (userMarker) {
                        map.removeLayer(userMarker);
                    }

                    // Add user marker
                    userMarker = L.marker(userLocation)
                        .addTo(map)
                        .bindPopup(`üìç Your Location<br>${currentUser.address}`);

                    // Draw route line
                    if (routeLine) {
                        map.removeLayer(routeLine);
                    }

                    routeLine = L.polyline([kitchenLocation, userLocation], {
                        color: '#f97316',
                        weight: 4,
                        opacity: 0.8,
                        className: 'route-line'
                    }).addTo(map);

                    // Fit map to show both markers
                    const group = new L.featureGroup([kitchenMarker, userMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            const distance = calculateDistance(
  kitchenLocation[0],
  kitchenLocation[1],
  userLocation[0],
  userLocation[1]
);

const eta = estimateDeliveryTime(distance); 

document.getElementById('estimatedTime').innerHTML = `
  <div class="text-sm text-gray-600">Distance</div>
  <div class="text-lg font-bold text-blue-800">${distance.toFixed(1)} km</div>
  <div class="text-sm text-gray-600 mt-1">ETA</div>
  <div class="text-lg font-bold text-blue-800">${eta} min</div>
`;

        }

        function setupEventListeners() {
            // Profile dropdown
            document.getElementById('profileBtn').addEventListener('click', function () {
                const dropdown = document.getElementById('profileDropdown');
                dropdown.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function (e) {
                const profileBtn = document.getElementById('profileBtn');
                const dropdown = document.getElementById('profileDropdown');
                if (!profileBtn.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.add('hidden');
                }
            });

            // Address editing
            document.getElementById('editAddressBtn').addEventListener('click', function () {
                document.getElementById('newAddress').value = currentUser.address;
                document.getElementById('addressModal').classList.remove('hidden');
            });

            document.getElementById('saveAddressBtn').addEventListener('click', function () {
                const newAddress = document.getElementById('newAddress').value.trim();
                if (newAddress) {
                    currentUser.address = newAddress;

                    // Update localStorage
                    localStorage.setItem('flavorcrateUser', JSON.stringify(currentUser));

                    const users = JSON.parse(localStorage.getItem('flavorcrateUsers') || '[]');
                    const userIndex = users.findIndex(u => u.email === currentUser.email);
                    if (userIndex !== -1) {
                        users[userIndex] = currentUser;
                        localStorage.setItem('flavorcrateUsers', JSON.stringify(users));
                    }

                    // Update UI
                    document.getElementById('profileAddress').textContent = newAddress;
                    document.getElementById('addressModal').classList.add('hidden');

                    // Update map
                    geocodeAndAddUserMarker();
                }
            });

            document.getElementById('cancelAddressBtn').addEventListener('click', function () {
                document.getElementById('addressModal').classList.add('hidden');
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function () {
                localStorage.removeItem('flavorcrateUser');
                window.location.href = 'login.html';
            });

            // Menu filters
            document.getElementById('filterAll').addEventListener('click', () => setFilter('all'));
            document.getElementById('filterVeg').addEventListener('click', () => setFilter('veg'));
            document.getElementById('filterNonVeg').addEventListener('click', () => setFilter('non-veg'));

            // Cart actions
            document.getElementById('checkoutBtn').addEventListener('click', checkout);
            document.getElementById('emptyCartBtn').addEventListener('click', emptyCart);
        }

        function setFilter(filter) {
                currentFilter = filter;
            // Update button styles
            document.querySelectorAll('[id^="filter"]').forEach(btn => {
                btn.className = 'px-6 py-2 rounded-full bg-gray-200 text-gray-700 font-medium transition hover:bg-gray-300';
            });

            const idMap = {
                'all': 'filterAll',
                'veg': 'filterVeg',
                'non-veg': 'filterNonVeg'
            };
            document.getElementById(idMap[filter]).className =
                'px-6 py-2 rounded-full bg-orange-500 text-white font-medium transition hover:bg-orange-600';

            renderMenu(currentFilter);
        }

        // Global functions for onclick handlers
        window.addToCart = addToCart;
        window.updateQuantity = updateQuantity;
    </script>
    <!-- Support / Contact Us Section -->
    <footer class="bg-white mt-12 border-t border-orange-100 text-center py-6 text-sm text-gray-600">
        <p>Need help? <a href="mailto:support@flavorcrate.com" class="text-orange-500 hover:underline">Contact Us</a>
        </p>
        <p>¬© 2025 FlavorCrate. All rights reserved.</p>
    </footer>

</body>

</html>